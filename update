#! /bin/bash

PROG=$0
die() {
    echo
    echo "$@"
    exit 1
}

BASEDIR="$(dirname "$(readlink -f "$0")")"
echo "Script Dir: $BASEDIR"

cd "$BASEDIR" || die "Could not change to $BASEDIR"

[ -f "$BASEDIR/.env" ] || die "$BASEDIR/.env is required"

echo "Updating Repo"
git pull

cat "$BASEDIR/.env"
set -a && source "$BASEDIR/.env" && set +a

[ -z "$DOTNET_CHANNELS" ] || die "DOTNET_CHANNELS not defined"
[ -z "$CACHE_ROOT" ] || die "CACHE_ROOT not defined"
[ -z "$DOTNET_CACHE_ROOT" ] || die "DOTNET_CACHE_ROOT not defined"
[ -z "$TRACKING_ROOT" ] || die "TRACKING_ROOT not defined"


[ -d "$CACHE_ROOT/nuget/packages/nuget" ] || mkdir -p "$CACHE_ROOT/nuget/packages/nuget"
[ -d "$CACHE_ROOT/nuget/packages/funfair-release" ] || mkdir -p "$CACHE_ROOT/nuget/packages/funfair-release"
[ -d "$CACHE_ROOT/nuget/packages/funfair-prerelease" ] || mkdir -p "$CACHE_ROOT/nuget/packages/funfair-prerelease"


echo "Updating docker"
sudo docker compose build && sudo docker compose up -d

echo "Done"