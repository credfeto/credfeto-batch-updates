#! /bin/sh

PROG=$0
die() {
    echo
    echo "$@"
    exit 1
}

BASEDIR="$(dirname "$(readlink -f "$0")")"
echo "Script Dir: $BASEDIR"

cd "$BASEDIR" || die "Could not change to $BASEDIR"

[ -f "$BASEDIR/.env" ] || die "$BASEDIR/.env is required"

echo "Updating Repo"
git pull

echo "Using $BASEDIR/.env"
. "$BASEDIR/.env"

echo "DOTNET_CHANNELS: $DOTNET_CHANNELS"
echo "CACHE_ROOT: $CACHE_ROOT"
echo "DOTNET_CACHE_ROOT: $DOTNET_CACHE_ROOT"
echo "TRACKING_ROOT: $TRACKING_ROOT"

echo "PACKAGES: $PACKAGES"
echo "REPOS_LIST: $REPOS_LIST"
echo "RELEASE: $RELEASE"
echo "TEMPLATE_CONFIG: $TEMPLATE_CONFIG"
echo "TEMPLATE: $TEMPLATE"
echo "ENV_PREFIX: $ENV_PREFIX"


[ -z "$DOTNET_CHANNELS" ] && die "DOTNET_CHANNELS not defined"
[ -z "$CACHE_ROOT" ] && die "CACHE_ROOT not defined"
[ -z "$DOTNET_CACHE_ROOT" ] && die "DOTNET_CACHE_ROOT not defined"
[ -z "$TRACKING_ROOT" ] && die "TRACKING_ROOT not defined"

[ -z "$PACKAGES" ] && die "PACKAGES not defined"
[ -z "$REPOS_LIST" ] && die "REPOS_LIST not defined"
[ -z "$RELEASE" ] && die "RELEASE not defined"
[ -z "$TEMPLATE_CONFIG" ] && die "TEMPLATE_CONFIG"
[ -z "$TEMPLATE" ] && die "TEMPLATE not defined"
[ -z "$ENV_PREFIX" ] && die "ENV_PREFIX not defined"


[ -d "$CACHE_ROOT/nuget/postgresql" ] || mkdir -p "$CACHE_ROOT/nuget/postgresql"
[ -d "$CACHE_ROOT/nuget/packages/nuget" ] || mkdir -p "$CACHE_ROOT/nuget/packages/nuget"
[ -d "$CACHE_ROOT/nuget/packages/funfair-release" ] || mkdir -p "$CACHE_ROOT/nuget/packages/funfair-release"
[ -d "$CACHE_ROOT/nuget/packages/funfair-prerelease" ] || mkdir -p "$CACHE_ROOT/nuget/packages/funfair-prerelease"

# Update scripts before building docker
cp "$BASEDIR/scripts/install-dotnet" "$BASEDIR/cleanup/"
cp "$BASEDIR/scripts/optimise-git" "$BASEDIR/cleanup/"
cp "$BASEDIR/scripts/setup-git" "$BASEDIR/cleanup/"
cp "$BASEDIR/scripts/setup-gpg" "$BASEDIR/cleanup/"

cp "$BASEDIR/scripts/install-dotnet" "$BASEDIR/dependencies/"
cp "$BASEDIR/scripts/optimise-git" "$BASEDIR/dependencies/"
cp "$BASEDIR/scripts/setup-git" "$BASEDIR/dependencies/"
cp "$BASEDIR/scripts/setup-gpg" "$BASEDIR/dependencies/"

cp "$BASEDIR/scripts/install-dotnet" "$BASEDIR/packages/"
cp "$BASEDIR/scripts/optimise-git" "$BASEDIR/packages/"
cp "$BASEDIR/scripts/setup-git" "$BASEDIR/packages/"
cp "$BASEDIR/scripts/setup-gpg" "$BASEDIR/packages/"

cp "$BASEDIR/scripts/install-dotnet" "$BASEDIR/templates/"
cp "$BASEDIR/scripts/optimise-git" "$BASEDIR/templates/"
cp "$BASEDIR/scripts/setup-git" "$BASEDIR/templates/"
cp "$BASEDIR/scripts/setup-gpg" "$BASEDIR/templates/"

echo "Updating docker"
sudo docker compose pull \
  && sudo docker compose build \
  && sudo docker compose up -d --remove-orphans

echo "Removing old images"
sudo docker image prune -f

echo "Done"