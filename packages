#! /bin/bash

PROG=$0
SCRIPT_DIR="$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"

function error_exit {
    echo
    echo "$@"
    exit 1
}
#Trap the killer signals so that we can exit with a good message.
trap "error_exit 'Received signal SIGHUP'" SIGHUP
trap "error_exit 'Received signal SIGINT'" SIGINT
trap "error_exit 'Received signal SIGTERM'" SIGTERM

shopt -s expand_aliases
alias die='error_exit "Error $PROG (@`echo $(( $LINENO - 1 ))`):"'

REPOS=

while [[ $# -gt 0 ]]; do
  key="$1"

  case $key in
    -r|--repositories)
      REPOS="$2"
      shift # past argument
      shift # past value
      ;;
    *)    # unknown option
      die "unknown argument $1"
      ;;
  esac
done

[ -z "$REPOS" ] && die "--repositories not specified"

WORK=${SCRIPT_DIR}/../work/${REPOS}/
[ -d "/zram" ] && WORK=/zram/packageupdate/${REPOS}/
LOGS=${SCRIPT_DIR}/../logs/${REPOS}/
LOG_FILE=${LOGS}/packages.log
LAST_LOG_FILE=${LOGS}/packages.old
REPOS_LIST=${SCRIPT_DIR}/config/${REPOS}/repos.lst
POWERSHELL=${SCRIPT_DIR}/scripts/powershell/UpdatePackages.ps1
PACKAGES=${SCRIPT_DIR}/config/packages.json

# OVERRIDE NUGET LOCATIONS
if [ -d "/zram" ] ; then
  export NUGET_PACKAGES=/zram/.nuget/packages/${REPOS}/packages
  echo "Updating NUGET_PACKAGES to ${NUGET_PACKAGES}"
  export NUGET_HTTP_CACHE_PATH=/zram/.nuget/packages/${REPOS}/cache
  echo "Updating NUGET_HTTP_CACHE_PATH to ${NUGET_HTTP_CACHE_PATH}"
  export NUGET_PLUGINS_CACHE_PATH=/zram/.nuget/packages/${REPOS}/plugins-cache
  echo "Updating NUGET_PLUGINS_CACHE_PATH to ${NUGET_PLUGINS_CACHE_PATH}"
  dotnet tool restore
fi

echo "Work: ${WORK}"
echo "Logs: ${LOGS}"
echo "Repos.lst: ${REPOS_LIST}"
echo "Powershell: ${POWERSHELL}"
echo "Packages.json: ${PACKAGES}"

echo "Path: ${PATH}"

[ ! -d "${LOGS}" ] && mkdir -p ${LOGS}
[ ! -d "${WORK}" ] && mkdir -p ${WORK}

[ ! -f "${REPOS_LIST}" ] && die "${REPOS_LIST} does not exist"
[ ! -f "${PACKAGES}" ] && die "${PACKAGES} does not exist"

[ -f "${LAST_LOG_FILE}" ] && rm ${LAST_LOG_FILE}
[ -f "${LOG_FILE}" ] && mv ${LOG_FILE} ${LAST_LOG_FILE}

echo "Changing to ${SCRIPT_DIR}"
cd ${SCRIPT_DIR}
echo "Running: dotnet pwsh -file ${POWERSHELL} -repos ${REPOS_LIST} -work ${WORK} -packagesToUpdate ${PACKAGES}"
dotnet pwsh -file ${POWERSHELL} -repos ${REPOS_LIST} -work ${WORK} -packagesToUpdate ${PACKAGES} > ${LOG_FILE} 2>&1
echo "Done"
